=== Ree Hat Data Grid モニタリング
:experimental:

==== モニタリングスタックの理解
OpenShift Container Platform には、設定済み・インストール済み・自身で更新することのできるモニタリングスタックが含まれており、プラットフォームのコアコンポーネントを監視することができます。
OpenShift Container Platform は、モニタリングのベストプラクティスを提供しています。
クラスタの問題をクラスタ管理者に即座に通知するアラートのセットがデフォルトで含まれています。
OpenShift Container Platform Web コンソールのデフォルトのダッシュボードには、クラスタのメトリクスを可視化するコンポーネントが提供されており、クラスタの状態を迅速に把握することができます。

OpenShift Container Platform のモニタリングスタックは、Prometheus オープンソースプロジェクトとその広範なエコシステムに基づいています。
モニタリングスタックには以下のコンポーネントが含まれています。:

*デフォルトのプラットフォームモニタリングコンポーネント* 

プラットフォームモニタリングコンポーネントの一式は、OpenShift Container Platform のインストール中にデフォルトで `openshift-monitoring` プロジェクトにインストールされます。
これは、Kubernetes サービスを含む OpenShift Container Platform のコアコンポーネントの監視を提供します。
デフォルトのモニタリングスタックは、クラスタのリモートヘルスモニタリングも可能にします。
これらのコンポーネントは、以下の図のデフォルトでインストールされているセクションに示されています。

*ユーザー定義プロジェクトをモニタリングするためのコンポーネント* 

オプションでユーザー定義プロジェクトのモニタリングを有効にすると、`openshift-user-workload-monitoring` プロジェクトに追加のモニタリングコンポーネントがインストールされます。
これにより、ユーザー定義プロジェクトのモニタリングが可能になります。
これらのコンポーネントは、以下の図のユーザーセクションに示されています。

image::ocp-prometheus-arch.png[Monitoring - Topology, 700]

本ハンズオンのクラスタでは、既にユーザー定義プロジェクトのモニタリングが有効化されており、`/metrics` を公開するすべてのアプリケーションでは、すべてのユーザーネームスペースにおいて Prometheus によってスクレイピングすることができます。
また、独自の Prometheus をインストールすることも可能であるため、様々なアーキテクチャやインフラに柔軟に対応することができます。

Openshift のワークロードのメトリクスを見て、Openshift の Web コンソール経由で収集されているメトリクスも見てみましょう。
Data Grid は、クラスタの状態を監視・可視化するため、Prometheus や Grafana が利用できるメトリクスを公開しています。

OpenShift Web Console において、*</> Developer* パースペクティブを選択します。下図のように `datagrid-service` が表示されるはずです。Data Grid クラスタのサービスをクリックし、右側のタブで `Observe` をクリックします。

image::monitoring-dg-dev-view.png[Monitoring - Topology, 700]

前の演習で作成した Infinispan カスタムリソースの定義を思い出してください。:

[source, yaml]
----
apiVersion: infinispan.org/v1
kind: Infinispan <1>
metadata:
  name: datagrid-service <2>
  namespace: {{ USER_ID }}-cache
spec:
  replicas: 2 <3>
  expose:
    type: LoadBalancer <4>
----

<1> Kubernetes/Openshift に対してカスタムリソースタイプが `Infinispan` であると指定
<2> クラスタ名を `datagrid-service` と指定
<3> サービスに必要なレプリカを指定
<4> Data Grid を外部へ公開

モニタリングが有効になっているかチェックするために、もう一度YAML定義を開きます。

<1> OpenShift コンソールにおいて Administrator パースペクティブを開きます。
<2> `Installed Operators > Data Grid > All instances`に移動します。
<3> `datagrid-service`をクリックします。
<4> 最後に YAML タブをクリックする。

By default, the monitoring should be enabled. Look for the following construct which is set to `true`:
デフォルトではモニタリングは有効になっているはずです。`true` に設定されている以下の構文を探してください。:

[source, yaml]
----
metadata:
  annotations:
    infinispan.org/monitoring: 'true'
----

次の写真は一例です。

image::monitoring-dg-yaml-view.png[Monitoring - Topology, 700]


これは、Prometheus がメトリクスを収集するために、Data Grid が /metrics エンドポイントでメトリクスを公開していることを意味します。

Openshift 4.6 以上では、Prometheus のメトリクスも取得できるようになりました。Data Grid サービスのメトリクスを見てみましょう。

<1> OpenShift Console の Developer パースペクティブに移動します。
<2> 正しい名前空間（ここでは `{{ USER_ID }}-cache` ）を選択していることを確認します。
<3> 左メニューの Observe をクリックし、Metrics をクリックします。
<4> Metricsタブを開き、Data Grid のメトリクスにクエリできることを確認します。

[source, shell, role="copypaste"]
----
vendor_cache_manager_default_cluster_size
----

次の図は、クラスタに2つのレプリカがあることを示すビューの例です。

image::monitoring-dg-metrics-view.png[Monitoring - Topology, 700]

カスタムクエリーエリアを使って、他のクエリーも試すことができます。

これで、Prometheusのメトリクスがうまく統合された環境で動作するようになった。Grafanaダッシュボードも設定しましょう。

様々なニーズをサポートするために、Data Grid Operator はコミュニティ版の Grafana Operator と連携し、Data Grid サービスのダッシュボードを作成することができます。
Grafana は、メトリクスを可視化するオープンソースのソリューションです。複数のデータソースを介してデータを整理することで、データをより意味のあるものにします。
例えば、Data Grid クラスターがたくさんある場合、このダッシュボードを使用してそれらすべてを追跡し、監視することができます。

Grafana ダッシュボードを設定してみましょう。Data Grid Operator がこれをやってくれます。しかし、その前に Grafana インスタンスを作成し、Operator が Data Grid ダッシュボードを構成する場所を知る必要があります。

まず、アプリケーションの Service Account を作成しましょう。右上の `+` 記号を押して、次の YAML を読み込み、Create を押します。

image::monitoring-create-sa-yaml.png[Monitoring - Topology, 500]

[source, yaml, role="copypaste"]
----
apiVersion: v1
kind: ServiceAccount
metadata:
  name: infinispan-monitoring
  namespace: {{ USER_ID }}-cache
----


これで、Grafana が Data Grid のメトリクスを読み込めるようにする Service Account を設定しました。

Grafana　インスタンスもセットアップしてみましょう。

OpenShift Console の右上にある `+` 記号を押し、以下のカスタムリソース YAML を読み込んで Grafana インスタンスを作成します。

[source, yaml, role="copypaste"]
----
apiVersion: integreatly.org/v1alpha1
kind: Grafana
metadata:
  name: grafana
spec:
  config:
    auth:
      disable_signout_menu: true
    auth.anonymous:
      enabled: true
    log:
      level: warn
      mode: console
    security:
      admin_password: secret
      admin_user: root
  ingress:
    enabled: true
  dashboardLabelSelector:
    - matchExpressions:
        - key: app
          operator: In
          values:
            - grafana
----

Prometheus 経由で Data Grid から Grafana にメトリクスを取得できるようにするために Datasource を設定します。
Openshiftのコンソールで、プロジェクトに入っていることを確認します： {{ USER_ID }}-cache に入っていることを確認し、右上の `+` 記号を押して以下の YAML をコピーします。

[source, shell, role="copypaste"]
----
apiVersion: integreatly.org/v1alpha1
kind: GrafanaDataSource
metadata:
  name: grafanadatasource
spec:
  name: datasource.yaml
  datasources:
    - access: proxy
      editable: true
      isDefault: true
      jsonData:
        httpHeaderName1: Authorization
        timeInterval: 5s
        tlsSkipVerify: true
      name: Prometheus
      secureJsonData:
        httpHeaderValue1: >-
          Bearer
          <YOUR  BEARER TOKEN HERE>
      type: prometheus
      url: 'https://thanos-querier.openshift-monitoring.svc.cluster.local:9091'
----

WARNING: Bearer Token の値を置き換える必要があります。

そのため、CodeReady Workspaces のターミナルにて以下のコマンドを実行します。ターミナルから OpenShift にログインしていること、プロジェクトが `{USER_ID }}-cache` であることを確認してください。

[source, shell, role="copypaste"]
----
oc serviceaccounts get-token infinispan-monitoring
----

出力には、Grafana Datasource　に使用する実際のトークンである長い文字列が得られるはずです。
このトークンをコピーして OpenShift のコンソールに戻り、`<YOUR BEARER TOKEN HERE>` を実際のトークンに置き換えてください。トークンは長く、暗号化されています。これによって Grafana は Data Grid と連携できるようになります。

最後のステップとしてダッシュボードを設定しましょう。
例えば、Grafana が別のネームスペースにあった場合、Data Grid はこのネームスペースを監視できるはずです。
そこで必要なのは、ダッシュボードのYAMLを作成することです。OpenShift コンソールの右上にある `+` 記号をクリックして、新しい YAML 設定を作成します。

[source, shell, role="copypaste"]
----
apiVersion: v1
kind: ConfigMap
metadata:
  name: infinispan-operator-config
data:
  grafana.dashboard.namespace: {{ USER_ID }}-cache
  grafana.dashboard.name: infinispan
  grafana.dashboard.monitoring.key: middleware
----

`create` を押すと、Grafana に `Infinispan` という新しいダッシュボードが作成されます。
ネームスペース内のすべての Data Grid インスタンスは Prometheus にデータを送信し、それが Grafana ダッシュボードにロードされます。
このカスタムリソースが削除されるとダッシュボードは存在しなくなります。

`Networking > Routes`に向かい、Grafana Route をクリックします。Grafana のランディングページが表示されるはずです。
下の図のように、管理メニューをクリックすると、`{USER_ID }}-cache` が表示され、その下に `Infinispan` ダッシュボードへのリンクが表示されます。

image::monitoring-grafana-dashboard-1.png[Monitoring - Topology, 700]

`Infinispan`をクリックすると、以下のダッシュボードがロードされます。

image::monitoring-grafana-dashboard-2.png[Monitoring - Topology, 700]


=== まとめ
<1> DataGrid Operator によるサービス監視
<2> OpenShift コンソールと Prometheus によるメトリクス
<4> Grafana データソースの作成
<5> Grafana ダッシュボードの作成

メトリックスとモニタリングの演習が完了しました。次の演習へ進みましょう。