=== (オプション) クロスサイトレプリケーション

あるデータセンターの Data Grid Operator は、別のデータセンターにおいて別の Data Grid Operator が管理している Data Grid クラスタを発見することができます。この発見により、Data Grid は自動的にクロスサイトビューを形成し、グローバルクラスタを作成することができます。

次の図は、ニューヨーク (NYC) のデータセンタにて Data Grid Operator が Data Grid クラスタを管理する例です。ロンドン (LON) の別のデータセンタでも Data Grid Operator が Data Grid クラスタを管理しています．

image::xsite-rhdg.png[Cross site - Topology, 700]


Data Grid Operator は、Kubernetes API を使用して、NYC と LON にある OpenShift Container Platform クラスタ間のセキュアな接続を確立します。
その後、Data Grid Operato は、Data Grid クラスタがロケーションを超えてデータをバックアップできるように、クロスサイトレプリケーションサービスを作成します。

各 Data Grid クラスタには、すべてのバックアップ要求を調整するサイトマスタノードが1つあります。
Data Grid Operator はサイトマスタノードを識別し、クロスサイトレプリケーションサービスを経由するすべてのトラフィックがサイトマスタに向かうようにします。

現在のサイトマスタノードがオフラインになると、新しいノードがサイトマスタになります。Data Grid Operator は新しいサイトマスタノードを自動的に検出し、バックアップ要求を転送するようにクロスサイトレプリケーションサービスを更新します。

これは演習であるため、2つの異なるクラスタを使用することはありませんが、この仕組みを理解するために2つの異なる Namespace を使用します。
以下の2つの Project/Namespace を利用します。:

<1> {{ USER_ID }}-cache - Site (NYC)
<2> {{ USER_ID }}-cache2 - Site (LON)


リンク:{{ CONSOLE_URL }}[OpenShift web console^]で `OpenShift` コンソールを開きます。

Project {{ USER_ID }}-cache を選択します。

And create a new Data Grid instance by Navigating to `Installed Operators > Data Grid > Create Infinispan ` as the following picture shows:
次図のように「Installed Operators > Data Grid > Create Infinispan」から新しい Data Grid インスタンスを作成します。:

image::create-infinispan.png[Cross site - Topology, 700]

`Create Infinispan` ボタンを押下します。

初めに、{{ USER_ID }}-cache に NYC ロケーションの Infinispan クラスタを作成します。

image::xsite-nyc-yaml.png[Cross site - Topology, 700]

以下の YAML をコピーして、上図のように `Create` を押します。:

[source, yaml, role="copypaste"]
----
apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-nyc
spec:
  replicas: 2
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error
  service:
    container:
      storage: 1Gi
    sites:
      local:
        expose:
          type: ClusterIP
        name: NYC
      locations:
        - clusterName: example-lon
          name: LON
          namespace: {{ USER_ID }}-cache2
          secretName: lon-token
          url: 'infinispan+xsite://example-lon-site.{{ USER_ID }}-cache2.svc:7900'    
    type: DataGrid
----


次に、プロジェクト `{{ USER_ID }}-cache2` の LON サイトでも同じことをしてみましょう。:

image::xsite-lon-yaml.png[Cross site - Topology, 700]

以下の YAML を読み込んで、上図のように `Create` を押します。:


[source, yaml, role="copypaste"]
----
apiVersion: infinispan.org/v1
kind: Infinispan
metadata:
  name: example-lon
spec:
  replicas: 2
  logging:
    categories:
      org.jgroups.protocols.TCP: error
      org.jgroups.protocols.relay.RELAY2: error
  service:
    container:
      storage: 1Gi
    sites:
      local:
        expose:
          type: ClusterIP
        name: LON
      locations:
        - clusterName: example-nyc
          name: NYC
          namespace: {{ USER_ID }}-cache
          secretName: lon-token
          url: 'infinispan+xsite://example-nyc-site.{{ USER_ID }}-cache.svc:7900'    
    type: DataGrid    
----

クラスタが Operator 経由でプロビジョニングを開始すると以下のように表示されるはずです。:

image::xsite-nyc-screenshot.png[Cross site - Topology, 700]

クラスタ名をクリックし `YAML` をクリックします。この YAML にはカスタムリソースの詳細が表示されますが、最も重要なのはそのステータスです。

image::xsite-nyc-status-yaml.png[Cross site - Topology, 700]


YAML の一番下までスクロールして、status タグをチェックします

[source, yaml, role="copypaste"]
----
status:
  conditions:
    - status: 'True'
      type: PreliminaryChecksPassed
    - message: 'View: example-nyc-0-63972,example-nyc-1-45654'
      status: 'True'
      type: WellFormed
    - message: 'Cross-Site view: LON'
      status: 'True'
      type: CrossSiteViewFormed
  podStatus:
    ready:
      - example-nyc-1
      - example-nyc-2
  statefulSetName: example-nyc
----

クロスサイトレプリケーションの設定ができたので、バックアップで Replicated Cache を作成し、いくつかのデータをロードしてその動作を確認してみよう。
ロンドン（LON）をプライマリーサイト、ニューヨーク（NYC）をセカンダリーサイトとしています。


この演習問題は、前の演習問題からの積み重ねです。自分自身に挑戦してください。

- LoadBalancer を両方のサイトクラスタに追加する。
- 両方のサイトの LoadBalancer アドレスを取得する。
- 両方のサイトのユーザ開発者のパスワードを取得する。

もし、解決策が分からないようでしたら、以下のコマンドをご覧ください。


*Solution*
[source, bash]
----
# change to the project
oc project {{ USER_ID }}-cache2

# get the console url for site LON
echo "https://$(oc get services | grep example-lon-external | awk '{ print $4 }'):11222"

# get the password for user developer to login to the console
echo "$(oc get secret example-lon-generated-secret -o jsonpath="{.data.identities\.yaml}" | base64 --decode | grep password | awk '{ print $2 }' )"
----

詳細がわかったところで、コンソールを開いてクロスサイトキャッシュを設定してみましょう。

image::dg8_createcache_console.png[Create cache, 700]

`Create cache` を押すと、以下のようなフォームが表示されます。フィールド `Provide Cache configuration` に以下の XML を追加して create を押します。:

image::dg8_createcacheform_console.png[Create cache, 700]

[source, xml]
----
<infinispan>
  <cache-container>
    <distributed-cache name="xsiteCache"> <1> 
      <encoding media-type="application/x-protostream"/> <2> 
      <backups>
        <backup site="NYC" strategy="SYNC"> <3> 
          <take-offline min-wait="120000"/> <4>
        </backup>
      </backups>
    </distributed-cache>
  </cache-container>
</infinispan>
----

<1> キャッシュ名
<2> キャッシュのメディアタイプ。XML、JSON、Java Serialization などから選択できます。
<3> ここでは、NYCをバックアップとして定義し、同期的であることを指定します。
<4> クラスタが動作していない場合は、指定された時間待ってからオフラインにします。

NYC サイトにも同じような設定をします。

[source, bash]
----
# change to the project
oc project {{ USER_ID }}-cache

# get the console url for site NYC
echo "https://$(oc get services | grep example-nyc-external | awk '{ print $4 }'):11222"

# get the password for user developer to login to the console
echo "$(oc get secret example-nyc-generated-secret -o jsonpath="{.data.identities\.yaml}" | base64 --decode | grep password | awk '{ print $2 }' )"
----


次の XML を使用して、再度キャッシュを作成する手順を繰り返します。今回は LON がバックアップサイトです。

[source, xml]
----
<infinispan>
  <cache-container>
    <replicated-cache name="xsiteCache">
      <encoding media-type="application/x-protostream"/>
      <backups>
        <backup site="LON" strategy="ASYNC" >
          <take-offline min-wait="120000"/>
        </backup>
      </backups>
    </replicated-cache>
  </cache-container>
</infinispan>

----

いくつかのエントリーを作ってみましょう。
エントリーを追加するには、メインコンソールページにおいて `xsiteCache` を押し、下図のように `Add Entry` を押します。キーは `1`、値は `Coffee` とします。

image::dg8_createentry_console.png[Create cache, 700]

NYC コンソールに行き、キャッシュの詳細サイトをチェックすると、下の画像のようなエントリーが表示されるはずです。

image::dg8_createentryoutput_console.png[Create cache, 700]


これでキャッシュが作成されたので、ウェブコンソールをブラウズすると、両方のクラスタに `xsiteCache` というキャッシュ名が表示されているはずです。

いずれかのクラスタのコンソールにアクセスすれば、エントリーを見ることができるはずだ。

=== まとめ
<1> つの異なるネームスペースに2つのサイトを作成。
<2> Data Grid Operator を使ってカスタムリソースを OpenShift にデプロイ。
<3> サービスを外部に公開。
<4> 2つのサイトにレプリケートされたキャッシュを作成。
<5> キャッシュにデータをロードし、どのようにレプリケートされるかを確認。キャッシュにデータをロードし、どのようにレプリケートされるかを確認。

これでクロスサイトレプリケーションの演習問題は完了です。
