=== Operator とは？
:experimental:

Operator は Kubernetes ネイティブアプリケーションをパッケージング・デプロイ・管理する方法です。
Kubernetes ネイティブアプリケーションは、Kubernetes 上にデプロイされ、Kubernetes API とツールを使用して管理されるアプリケーションです。
Operatorは 基本的にカスタムコントローラであり運用知識をカプセル化します。

コントローラーは Kubernetes のコアコンセプトであり、Kubernetes 上で継続的に実行されるソフトウェアループとして実装され、期待される状態と現在の状態のオブジェクトのリコンサイルを行います。
オブジェクトとは `Pods`、`Services`、`ConfigMaps`、`PersistentVolumes` などのよく知られたリソースです。
Operator はアプリケーション全体のレベルでこのモデルを適用し、実質的にアプリケーション固有のコントローラーとなります。

Operator はクラスタ上の `Pod` で動作するソフトウェアであり、Kubernetes API サーバーとやり取りします。
Kubernetes の拡張メカニズムである Custom Resource Definition を通じて、新しいオブジェクトタイプを導入します。
これらのカスタムオブジェクトは、Kubernetes クラスタ上のリソースベースのインタラクションモデルと一致しており、ユーザーにとっての主要なインターフェイスです。

Operator はこれらのカスタムリソースタイプを監視し、その存在または変更について通知されます。
Operator はこの通知を受け取ると、ループの実行を開始し、これらのオブジェクトで表されるアプリケーションサービスに必要なすべての接続が利用可能であり、ユーザーがオブジェクトの仕様で表現した方法で構成されていることを確認します。

Operator Lifecycle Manager（OLM）は、Kubernetes クラスタ上の Operator の管理を容易にします。
アプリケーションをサービスとして提供する Operator は、潜在的にクラスタ上で多くのパーミッションを持つ長寿命のワークロードになる可能性があります。

OLM を使用すると、管理者はどのネームスペースにどの Operator を使用できるかを制御し、誰が実行中の Operator と対話できるかを制御できます。
Operator の権限は、最小特権アプローチに従うように自動的に正確に設定されます。
OLM は、他の Operator への依存関係の解決、Operator とそれが管理するアプリケーションの両方への更新のトリガー、クラスタのスライスに対する Operator への特定のチームのアクセス権の付与などを行うことで、Operator とそのリソースの全体的なライフサイクルを管理します。

Red Hat Data Grid 8 には Operator が付属しています。本ワークショプ環境では、すでに Data Grid Operator がインストールされています。
ユーザーとして必要なことは、Red Hat Data Grid インスタンスに必要な設定のカスタムリソースを作成することです。


=== Data Grid のインストール

始めに2つの異なる場所からログインする必要があります。:

* *STEP 1*: OpenShift Dev Spaces のターミナルからまだ OpenShift にログインしていない場合、右メニューの `Workspace` にある `Login to Openshift` メニューをクリックします。プロンプトが表示されたら、*Username* は `{{ USER_ID }}` で、*Password* は `{{OPENSHIFT_USER_PASSWORD }}` です。

* *STEP 2*: OpenShift Web Console にもアクセスする必要があります。 {{ CONSOLE_URL }}[OpenShift web console^] を新しいタブで開きます。ログインするよう促されますので、以下の認証情報を使用してください。:

** Username: `{{ USER_ID }}`.
** Password: `{{ OPENSHIFT_USER_PASSWORD }}`.

image::openshift-login-page.png[openshift_login, 700]

ログインすると、2つのプロジェクトが表示されます。プロジェクト `{{ USER_ID }}-cache` を選択してください。

image::openshift-namespaces.png[openshift-namespaces, 700]


上の画像のように、*Administrator* ビューに変更します。下図のように、左側のナビゲーションセクションにおいて `Operators > インストール済みの Operator` のリンクをクリックします。

image::openshift-installed-operators.png[openshift-installed-operators, 700]

Namespaces に Data Grid オペレータが既にインストールされていることに注意してください。これを選択し、*Infinispan Cluster* タブに移動します。

image::openshift-datagrid-operator-view.png[openshift-datagrid-operator-view, 700]

Namespaces に Data Grid クラスタがインストールされていないことが分かります。それでは作成してみよう。`Infinispanの作成` をクリックし、`YAML ビュー` を選択し、デフォルトの定義を以下の YAML に置き換えます。: 

[source, yaml, role="copypaste"]
----
apiVersion: infinispan.org/v1
kind: Infinispan <1>
metadata:
  name: datagrid-service <2>
  namespace: {{ USER_ID }}-cache
spec:
  replicas: 2 <3>
----

<1> Kubernetes または Openshift に `Infinispan` というカスタムリソースがあることを伝えます
<2> クラスタ名を `datagrid-service` にします
<3> サービスに必要なレプリカ数を指定します

NOTE: このサービスを `datagrid-service` と呼ぶことにします。以下の演習ではこの名前を使ってクラスタにアクセスします。

一番下にある *作成* をクリックし、Data Grid ノードが正常にクラスタを構成するまで待ちます。

コマンドラインから Data Grid カスタムリソースを確認してみましょう。これを行うには、OpenShift Dev Spaces に移動し、Openshift にログインします。

image::che_openshift_login.png[openshift_login, 700]

ログインすると、以下のメッセージが表示されるはずです。:

[source, shell]
----
Login successful.

You have access to the following projects and can switch between them with 'oc project <projectname>':

  * {{ USER_ID }}-cache
    {{ USER_ID }}-cache2

Using project "{{ USER_ID }}-cache".
Welcome! See 'oc help' to get started.
----

前のセクションと同じように、OpenShift Dev Spaces ワークスペースにおいて `>_ New Terminal` を開始し、以下のコマンドを実行します。

[source, shell, role="copypaste"]
----
oc get infinispan -o yaml
----

レスポンスには、以下の例のように Data Grid ノードがクラスタ化されたビューを受け取ったことが表示されます。:

[source, shell]
----
conditions:
  - message: 'View: datagrid-service-0-xxxx, datagrid-service-1-xxxx'
    status: "True"
    type: WellFormed
----


コンディションチェックを待つこともできます。

[source, shell, role="copypaste"]
----
oc wait --for condition=wellFormed --timeout=240s infinispan/datagrid-service
----

以下のようにログからクラスタビューを確認してみましょう。

[source, shell, role="copypaste"]
----
oc logs datagrid-service-0 | grep ISPN000094
----

[source, shell]
----
INFO  [org.infinispan.CLUSTER] (MSC service thread 1-2) \
ISPN000094: Received new cluster view for channel datagrid-service: \
[datagrid-service-0-xxxx|0] (1) [datagrid-service-0-xxxx]

INFO  [org.infinispan.CLUSTER] (jgroups-3,datagrid-service-0) \
ISPN000094: Received new cluster view for channel datagrid-service: \
[datagrid-service-0-xxxx|1] (2) [datagrid-service-0-xxxx, datagrid-service-1-xxxx]
----

以下のコマンドを実行して、Red Hat Data Grid Operator を実行している Pod とインスタンスを探すこともできます。:

[source, shell, role="copypaste"]
----
oc get pods
----

上記のコマンドは以下のような出力になるはずです。

[source, shell]
----
[jboss@workspacel7b3gw19zpoclvcu dg8-operator]$ oc get pods
NAME                                                      READY   STATUS    RESTARTS   AGE
datagrid-service-0                                        1/1     Running   0          13m
datagrid-service-1                                        1/1     Running   0          12m
datagrid-service-config-listener-567dd95fd-hsf99          1/1     Running   0          12m
grafana-operator-controller-manager-745f467f5b-4kpc5      2/2     Running   2          9h
infinispan-operator-controller-manager-5b7c8f7874-dfwn8   1/1     Running   1          9h
----

Service やその設定 (TYPE、PORTS など) もチェックしてみましょう。

[source, shell, role="copypaste"]
----
oc get services
----

上記のコマンドを実行すると、以下の例のような出力が表示されるはずです。すべての Service が表示されます。:

[source, shell]
----
NAME                                                  TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE
datagrid-service                                      ClusterIP   172.30.137.236   <none>        11222/TCP   15m
datagrid-service-admin                                ClusterIP   None             <none>        11223/TCP   15m
datagrid-service-ping                                 ClusterIP   None             <none>        8888/TCP    15m
...
----

3つの Data Grid Service があること分かります。:

- `datagrid-service` : OpenShift クラスタ上のアプリケーションから利用される
- `datagrid-service-admin` : Operator によってクラスタの設定と通信に利用される
- `datagrid-service-ping` : クラスタが健全に動作していることを確認する

Operator はクラスタの正しい状態を常に維持しています。
このため、クラスタ設定を直接編集する必要はなく、Operator が常に監視しているカスタムリソースを介して定義する必要があります。
`datagrid-service` に外部ルートを追加してみましょう。

`datagrid-service` カスタムリソースを編集してみましょう。

下図のように、`Infinispanの編集` をクリックします。

image::dg_edit_CR.png[Edit CR, 700]

クラスタインスタンスが作成されると、Operator によって追加されたタイムスタンプやラベルなどの追加情報が YAML に表示されるはずです。


`spec:` に変更を加えます。spec 配下の `replicas` へ移動し、下図のように追加します。

[source, shell, role="copypaste"]
----
  expose:
    type: LoadBalancer
----

image::dg_edit_CR_LoadBalancer.png[Edit and Save, 700]

`保存` してください。

<1> `インストール済みの Operator > Data Grid > Infinispan Cluster` に戻り、`datagrid-service` をクリックします。
<2> 次に `リソース > datagrid-service-external` をクリックします。`サービスアドレス` ページが表示され、Data Grid コンソールへのロードバランサーへの公開リンクが表示されます。

image::dg_CR_detailview.png[DG cluster detail view, 700]


以下は例ですが、以下のような `LoadBalancer` URL が表示されるはずです。

* `a256fafe1f822452fb4c2fb3e3a5aff6-1344204513.us-east-2.elb.amazonaws.com`


プロトコル `https` と Data Grid のポート `11222` を指定して URL にアクセスしようとした場合、署名された証明書を使用していないため警告は無視できます。

* `https://a256fafe1f822452fb4c2fb3e3a5aff6-1344204513.us-east-2.elb.amazonaws.com:11222/`

認証情報を提供する必要があります。

Data Grid Operator は、インストール時に認証情報を作成し、Namespace の Secret に保存しています。OpenShift Dev Spaces のターミナルに戻ってください。以下のコマンドを用いて Secret を取得しましょう。

[source, shell, role="copypaste"]
----
oc get secret datagrid-service-generated-secret -o jsonpath="{.data.identities\.yaml}" | base64 --decode
----

クラスタが稼働していることの最後のテストをします。ユーザ名 developer、パスワードには上記の Secret を用いてログインします。

image::dg_adminconsole.png[openshift_login, 900]


==== Data Grid クラスタの停止・起動
クラスタの状態を正常に保持するには、Data Grid ノードを安全に順序よく停止・起動する必要があります。

Data Grid クラスタは、シャットダウン前と同じノード数で再起動する必要があります。これにより、Data Grid はクラスタ全体のデータ分散を復元できます。Data Grid Operator がクラスタを完全に再起動した後、ノードを安全に追加および削除できます。

カスタムリソースの `spec.replicas` フィールドを 0 に変更し、Data Grid クラスタを停止します。

[source, shell, role="copypaste"]
----
spec:
  replicas: 0
----

クラスタを再起動する前に、ノード数が正しいことを確認してください。

[source, shell]
----
oc get infinispan datagrid-service -o=jsonpath='{.status.replicasWantedAtRestart}'
----

`spec.replicas` フィールドを同じノード数に変更し、Data Grid クラスタを再起動します。

[source, shell, role="copypaste"]
----
spec:
  replicas: 2
----

==== Data Grid サービスの種類

Data Grid には2種類のサービスがあります。:

<1> Cache サービス
<2> DataGrid サービス

それぞれのサービスは Data Grid サーバーイメージに基づくステートフルなアプリケーションであり、柔軟で堅牢なインメモリデータストレージを提供します。
`spec.service.type` フィールドに値を指定しない場合、Data Grid Operator はデフォルトで Cache サービスを作成します。
それぞれのサービスにはそれぞれ異なる利点があり、アプリケーションは Data Grid が提供するさまざまな機能を利用できます。

*Cache サービス*

最小限の構成で揮発性・低レイテンシーのデータストアが必要な場合は Cache サービスを使用します。

* データストレージの需要が増加または減少した場合、容量に合わせて自動的に拡張します。
* 同期的にデータを分散し、一貫性を確保します。
* クラスタ全体でキャッシュの各エントリを複製します。
* キャッシュエントリーをオフヒープに格納し、JVM の効率化のために Eviction を使用します。
* デフォルトのパーティション処理構成でデータの一貫性を確保します。

Cache サービスは揮発性であるため、Data Grid カスタムリソースにてクラスタに変更を適用したり、Data Grid のバージョンを更新したりすると、すべてのデータが失われます。

*Data Grid サービス*

* クロスサイトレプリケーションによるグローバルなクラスタ間でのデータのバックアップができます。
* 任意の有効な構成でキャッシュを作成できます。
* ファイルベースのキャッシュストアを追加して、データを永続ボリュームに保存できます。
* Data Grid Query API を使用したキャッシュ間の値のクエリを実行できます。
* 高度なデータグリッドの特徴と機能の使用できます。

このセクションの例では、Cache サービスを使用していることにお気づきかもしれませんが、これからの演習では様々なサービスとそれに付随する機能を設定します。

=== まとめ

<1> 最初に Infinispan カスタムリソースを作成しました。
<2> Data Grid Operator を使用してカスタムリソースを Openshift にデプロイしました。
<3> Data Grid インスタンスをインストールしました。
<4> サービスを外部に公開しました。
<5> カスタムリソース経由で Data Grid を停止・起動し、ステータス/ログを追跡する方法を学びました。
<6> 2種類のサービスの違いを説明しました。

本ハンズオンの最初の Data Grid のインストールが完了しました。次の演習では、このインスタンスを Quarkus アプリケーションのリモートとして使用する方法を学びましょう。
